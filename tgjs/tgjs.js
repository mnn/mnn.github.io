/**
 * TinyGalleryJS - Tiny library providing basic gallery entirely on a client side.
 * @author monnef
 * @version v0.1.0
 * @link https://github.com/mnn/TinyGalleryJS
 * @license CPAL-1.0
 */
(function(){var t,n,e,i,r,a,l,u,o,s,c,d;e="TinyGalleryApp",n=angular.module(e,["ui.router"]),t="LinkPageChanged",o=function(){var t;return t=TinyGalleryAppSettings||{},t.includeDir=t.includeDir||"./tiny-gallery-js/",t.dataDir=t.dataDir||"./",t.nearPagesCount=t.nearPagesCount||3,t.thumbnailsHalfCount=t.thumbnailsHalfCount||3,t.firstThumbnailIndex=t.firstThumbnailIndex||1,t.links=t.links||[],t},d=o(),l=d.debug||!1,u=!1,s=function(t){return l&&console&&"function"==typeof console.log?console.log("["+e+"][DEBUG]: "+t):void 0},c=function(t){return console&&"function"==typeof console.log?console.log("["+e+"][ERR]: "+t):void 0},s("settings:\n"+JSON.stringify(d,null," ")),n.config(["$stateProvider","$urlRouterProvider",function(n,e){n.state("tiles",{url:"/tiles/{page:int}",templateUrl:d.includeDir+"tiles.html",controller:["$stateParams","$rootScope",function(n,e){s("running tiles controller"),e.$emit(t,n.page)}]}).state("detail",{url:"/detail/{id:int}",templateUrl:d.includeDir+"detail.html",controllerAs:"detailCtrl",controller:["$stateParams","$scope","keyPress","$state","$timeout",function(t,n,e,i,r){var a,l,u,o;s("running detail controller"),this.thumbnailsHalfCount=d.thumbnailsHalfCount,this.pictureId=t.id,this.lastId=-1,this.init=function(t){return function(){return s("detail ctrl detected ready dataPromise"),n.mainCtrl.dataPromise.then(function(){var e,i,r;return s("detail controller is processing data"),e=n.mainCtrl.data.data,t.picture=e[t.pictureId],n.picture=t.picture,n.pictureId=t.pictureId,i=t.pictureId-t.thumbnailsHalfCount,r=t.pictureId+t.thumbnailsHalfCount+1,0>i&&(r+=-i,i=0),t.lastId=e.length-1,r>t.lastId&&(i-=r-t.lastId-1,0>i&&(i=0),r=t.lastId+1),n.pictures=e.slice(i,r),n.allPictures=e})}}(this),this.tryInit=function(t){return function(){return s("detail ctrl: try init"),n.mainCtrl.dataPromise?t.init():r(t.tryInit,50)}}(this),this.tryInit(),l=37,u=39,a=27,o=function(t){return function(n){return 0>n?0:n>t.lastId?t.lastId:n}}(this),n.wrapPictureId=o,e.bind(function(t){return function(e){var r;switch(r=function(t){var n;return n=o(t),s("Going to detail pic #"+n+" (raw id = "+t+")."),i.go("detail",{id:n})},e){case l:return r(t.pictureId-1);case u:return r(t.pictureId+1);case a:return i.go("tiles",{page:n.mainCtrl.pageForPicture(t.pictureId)})}}}(this)),n.getPicLink=function(t){return function(e){return n.allPictures&&t.pictureId?n.allPictures[o(e)].galleryPicture:""}}(this)}]}),e.otherwise("/tiles/0")}]),a=function(t,n){return angular.isDefined(t.newWindow)?n.newWindow=t.newWindow:void 0},i=function(t){var n,e,i;if(n=t.linkId,i=d.links.filter(function(t){return t.id===n}),0===i.length)return c("Cannot find link in settings for id: "+n);switch(e=i[0],e.type){case"prefix":return t.data=t.data.map(function(t){return t.link=e.url+t.link,t}),a(e,t);default:c("Unknown link type: "+e.type)}},r=function(t){var n;return n=0,t.newWindow=angular.isDefined(t.newWindow)?t.newWindow:!1,t.galleryPrefix=t.galleryPrefix||"",t.data=t.data.map(function(e){return e.galleryPicture=t.galleryPrefix+e.link,e.thumbnail=e.thumbnail.map(function(n){return n=t.galleryPrefix+n}),e.link="#/detail/"+n++,e})},n.service("utils",function(){this.range=function(t,n,e){var i,r;for(e=e||1,i=[t],r=t;n>r;)r+=e,i.push(r);return i}}),n.filter("startFrom",function(){return function(t,n){return t?(n=+n,t.slice(n)):[]}}),n.directive("tinyGallery",function(){return{restrict:"E",scope:{src:"@"},templateUrl:d.includeDir+"tiny-gallery.html",controllerAs:"mainCtrl",controller:"MainController"}}),n.controller("MainController",["$http","$scope","$log","$element","$interval","$rootScope","utils",function(n,e,a,l,o,c,g){var m;this.data={empty:!0},this.currentPage=0,this.pageSize=9,m=d.dataDir+e.src,s("starting loading file: "+m),this.initPage=0,this.dataLoaded=!1,this.dataPromise=n.get(m).success(function(t){return function(n){var e,l;switch(s("data received, got:"+JSON.stringify(n)+"\n"),t.data=n,t.data.thumbnailTimer=t.data.thumbnailTimer||1e3,t.data.flip=angular.isDefined(t.data.flip)?t.data.flip:!1,t.data.itemsPerPage=t.data.itemsPerPage||9,t.data.thumbnailPrefix=t.data.thumbnailPrefix||"",l=d.firstThumbnailIndex,e=0,t.data.flip&&!u&&(t.data.data=t.data.data.reverse()),t.data.data.forEach(function(t){return t.defaultThumbnailIdx=t.thumbnail.length>l?l:0,t.currentThumbnailIdx=t.defaultThumbnailIdx,t.id=e++}),t.pageSize=t.data.itemsPerPage,t.thumbnailPrefix=t.data.thumbnailPrefix,t.data.type){case"direct":break;case"fromSettings":i(t.data);break;case"gallery":r(t.data);break;default:a.error("Unknown data type: "+t.data.type)}return t.openLinksInNewWindow=angular.isDefined(t.data.newWindow)?t.data.newWindow:!1,t.data.data=t.data.data.map(function(n){return n.thumbnail=n.thumbnail.map(function(n){return t.thumbnailPrefix+n}),n}),t.dataLoaded=!0,t.numberOfPictures=function(){return t.data.data.length},0!==t.initPage&&(s("applying init page "+t.initPage),t.changePage(t.initPage,!1)),t.initializeIntervalForThumbnailRotation()}}(this)).error(function(t){return function(t){return a.error("Unable to fetch data file '"+m+"': "+t)}}(this)),c.$on(t,function(t){return function(n,e){return t.dataLoaded?t.changePage(e,!0):t.initPage=e}}(this)),this.numberOfPages=function(t){return function(){return t.data&&t.data.data?Math.ceil(t.data.data.length/t.pageSize):0}}(this),this.wrapPageNumber=function(t){return function(n){return 0>n?0:n>=t.numberOfPages()?t.numberOfPages()-1:n}}(this),this.changePage=function(t){return function(n,e){var i;return i=t.wrapPageNumber(n),s("Changing page to "+i+" (raw = "+n+")"),i!==t.currentPage&&(t.currentPage=i,e)?t.scrollToTop():void 0}}(this),this.getCurrentPage=function(t){return function(){return t.currentPage}}(this),this.pageForPicture=function(t){return function(n){return Math.floor(n/t.pageSize)}}(this),this.goPageRelative=function(t){return function(n,e){return t.changePage(t.getCurrentPage()+n,e)}}(this),this.scrollToTop=function(t){return function(){}}(this),this.rotateThumbnail=function(t){return function(){var n;if(n=t.itemForThumbnailRotation){if(t.skipOneThumbRotation)return t.skipOneThumbRotation=!1;if(n.currentThumbnailIdx+=1,n.currentThumbnailIdx>=n.thumbnail.length)return n.currentThumbnailIdx=0}}}(this),this.itemForThumbnailRotation=null,this.intervalForThumbnailRotation=null,this.startThumbnailRotation=function(t){return function(n){return t.itemForThumbnailRotation=n,t.itemForThumbnailRotation.currentThumbnailIdx=0,t.skipOneThumbRotation=!0}}(this),this.stopThumbnailRotation=function(t){return function(n){return t.intervalForThumbnailRotation&&t.itemForThumbnailRotation?(t.itemForThumbnailRotation.currentThumbnailIdx=t.itemForThumbnailRotation.defaultThumbnailIdx,t.itemForThumbnailRotation=null):void 0}}(this),this.initializeIntervalForThumbnailRotation=function(t){return function(){return t.intervalForThumbnailRotation=o(t.rotateThumbnail,t.data.thumbnailTimer)}}(this),this.nearPagesCount=d.nearPagesCount,this.getNearPages=function(t){return function(){var n,e;return n=t.wrapPageNumber(t.getCurrentPage()-t.nearPagesCount),e=t.wrapPageNumber(t.getCurrentPage()+t.nearPagesCount),g.range(n+1,e+1)}}(this),this.nearPagesOpenLeft=function(t){return function(){return t.getCurrentPage()>t.nearPagesCount}}(this),this.nearPagesOpenRight=function(t){return function(){return t.getCurrentPage()<t.numberOfPages()-t.nearPagesCount-1}}(this)}]),n.directive("tinyGalleryControls",function(){return{restrict:"E",scope:{doScroll:"@",ctrl:"="},templateUrl:d.includeDir+"controls.html",controller:["$scope","utils",function(t,n){return t.utils=n}]}}),n.service("keyPress",function(){var t,n;t=[],n=function(n){return function(n){var e,i,r,a;for(a=[],i=0,r=t.length;r>i;i++)e=t[i],a.push(e(n.keyCode));return a}}(this),angular.element(document).bind("keypress",n),this.bind=function(n){return function(n){return t.push(n)}}(this)}),n.run(["$location","$rootScope","$state","$stateParams",function(t,n,e,i){return n.$on("$stateChangeError",console.log.bind(console)),"/noSort"===t.url()?u=!0:void 0}]),angular.element(document).ready(function(){var t,n,i,r,a;for(t=document.querySelectorAll("tiny-gallery"),a=[],n=0,r=t.length;r>n;n++)i=t[n],a.push(angular.bootstrap(i,[e]));return a})}).call(this),angular.module("TinyGalleryApp").run(["$templateCache",function(t){t.put("./tiny-gallery-js/controls.html",'<div class=tg-controls><a ui-sref="tiles({page: 0})" class=tg-control-page ng-class="{\'tg-control-page-active\': ctrl.getCurrentPage() <= 0}">&lt;&lt;</a> <a ui-sref="tiles({page: ctrl.getCurrentPage() - 1 })" class=tg-control-page ng-class="{\'tg-control-page-active\': ctrl.getCurrentPage() == 0}">&lt;</a> <span ng-show=ctrl.nearPagesOpenLeft()>&ctdot;</span> <a ng-repeat="num in ctrl.getNearPages()" class=tg-control-page ng-class="{\'tg-control-page-active\': ctrl.getCurrentPage() + 1 == num}" ui-sref="tiles({page: num - 1})">{{num}}</a> <span ng-show=ctrl.nearPagesOpenRight()>&ctdot;</span> <a ui-sref="tiles({page: ctrl.getCurrentPage() + 1 })" class=tg-control-page ng-class="{\'tg-control-page-active\': ctrl.getCurrentPage() + 1 >= ctrl.numberOfPages()}">&gt;</a> <a ui-sref="tiles({page: ctrl.numberOfPages() - 1 })" class=tg-control-page ng-class="{\'tg-control-page-active\': ctrl.getCurrentPage() + 1 >= ctrl.numberOfPages()}">&gt;&gt;</a></div>'),t.put("./tiny-gallery-js/detail.html",'<div class=tg-detail><div class=tg-detail-top><div ng-repeat="pic in pictures" class=tg-detail-thumb><img ng-src={{pic.thumbnail[0]}} class=tg-button ui-sref="detail({id: pic.id})" ng-class="{\'tg-detail-thumb-current\': pic.id == pictureId}"></div></div><div class=tg-bg-picture style="background-image: url({{picture.galleryPicture}});"></div><div class=tg-detail-preload><img ng-src="{{getPicLink(pictureId - 1)}}"> <img ng-src="{{getPicLink(pictureId + 1)}}"></div><div class=tg-detail-bottom><div class=tg-detail-title>{{picture.title}}</div><div class=tg-detail-controls><div class=tg-detail-controls-item><div class=tg-control-page ng-show="pictureId > 0" ui-sref="detail({id:pictureId - 1})">&lt;</div></div><div class=tg-detail-controls-item><div class="tg-control-page tg-detail-back"><a ui-sref="tiles({page: mainCtrl.pageForPicture(pictureId)})">Close</a></div><div class=tg-control-numbering>{{pictureId + 1}} / {{ mainCtrl.numberOfPictures() }}</div></div><div class=tg-detail-controls-item><div class=tg-control-page ng-show="pictureId + 1 < mainCtrl.numberOfPictures()" ui-sref="detail({id:pictureId + 1})">&gt;</div></div></div></div></div>'),t.put("./tiny-gallery-js/tiles.html","<tiny-gallery-controls ctrl=mainCtrl></tiny-gallery-controls><div class=tg-cells><div class=tg-cell ng-repeat=\"item in mainCtrl.data.data | startFrom: mainCtrl.currentPage * mainCtrl.pageSize | limitTo: mainCtrl.pageSize\"><div class=tg-cell-content><a ng-href={{item.link}} target=\"{{mainCtrl.openLinksInNewWindow ? '_blank':''}}\"><div class=tg-img-wrapper><img ng-src={{item.thumbnail[item.currentThumbnailIdx]}} ng-mouseenter=mainCtrl.startThumbnailRotation(item) ng-mouseleave=mainCtrl.stopThumbnailRotation(item)><div class=tg-cell-duration>{{item.duration}}</div></div></a><div class=tg-cell-title>{{item.title}}</div></div></div></div><div class=tg-clearer></div><tiny-gallery-controls ctrl=mainCtrl do-scroll=true></tiny-gallery-controls>"),t.put("./tiny-gallery-js/tiny-gallery.html","<div class=tg-main><ui-view></ui-view></div>")}]);